generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                         String                  @id @default(uuid()) @db.Uuid
  email                      String                  @unique @db.VarChar(255)
  passwordHash               String                  @map("password_hash") @db.VarChar(255)
  role                       enum_users_role         @default(student)
  fullName                   String?                 @map("full_name") @db.VarChar(255)
  phone                      String?                 @db.VarChar(255)
  profilePictureUrl          String?                 @map("profile_picture_url") @db.VarChar(255)
  isVerified                 Boolean?                @default(false) @map("is_verified")
  verification_token         String?                 @db.VarChar(255)
  verification_token_expires DateTime?               @db.Timestamptz(6)
  reset_password_token       String?                 @db.VarChar(255)
  reset_password_expires     DateTime?               @db.Timestamptz(6)
  refresh_token              String?
  createdAt                  DateTime                @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt                  DateTime                @updatedAt @map("updated_at") @db.Timestamptz(6)
  admins                     admins?
  emailVerificationToken     EmailVerificationToken?
  faculty                    Faculty?
  passwordResetTokens        PasswordResetToken[]
  refreshTokens              RefreshToken[]
  student                    Student?
  mealReservations           MealReservation[]
  wallet                     Wallet?
  eventRegistrations         EventRegistration[]
  classroomReservations      ClassroomReservation[]

  @@map("users")
}

model Faculty {
  id             String     @id @default(uuid()) @db.Uuid
  userId         String     @unique @map("user_id") @db.Uuid
  employeeNumber String     @unique @map("employee_number") @db.VarChar(255)
  title          String     @db.VarChar(255)
  departmentId   String     @map("department_id") @db.Uuid
  created_at     DateTime   @default(now()) @db.Timestamptz(6)
  updated_at     DateTime   @updatedAt @db.Timestamptz(6)
  department     Department @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  user           User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("faculty")
}

model Student {
  id                String               @id @default(uuid()) @db.Uuid
  userId            String               @unique @map("user_id") @db.Uuid
  studentNumber     String               @unique @map("student_number") @db.VarChar(255)
  departmentId      String               @map("department_id") @db.Uuid
  gpa               Decimal?             @default(0.0) @db.Decimal(3, 2)
  cgpa              Decimal?             @default(0.0) @db.Decimal(3, 2)
  created_at        DateTime             @default(now()) @db.Timestamptz(6)
  updated_at        DateTime             @updatedAt @db.Timestamptz(6)
  attendanceRecords attendance_records[]
  enrollments       enrollments[]
  excuseRequests    excuse_requests[]
  department        Department           @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  user              User                 @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("students")
}

model EmailVerificationToken {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @unique @map("user_id") @db.Uuid
  token     String   @unique @db.VarChar(255)
  expiresAt DateTime @map("expires_at") @db.Timestamptz(6)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("email_verification_tokens")
}

model PasswordResetToken {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  token     String   @unique @db.VarChar(255)
  expiresAt DateTime @map("expires_at") @db.Timestamptz(6)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("password_reset_tokens")
}

model RefreshToken {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  token     String   @unique @db.Text
  expiresAt DateTime @map("expires_at") @db.Timestamptz(6)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("refresh_tokens")
}

model Department {
  id          String    @id @default(uuid()) @db.Uuid
  name        String    @db.VarChar(255)
  code        String    @unique @db.VarChar(255)
  facultyName String    @map("faculty") @db.VarChar(255)
  createdAt   DateTime  @map("created_at") @db.Timestamptz(6)
  updated_at  DateTime  @db.Timestamptz(6)
  courses     courses[]
  faculty     Faculty[]
  students    Student[]

  @@map("departments")
}

model SequelizeMeta {
  name String @id @db.VarChar(255)
}

model admins {
  id              String    @id @db.Uuid
  user_id         String    @unique @db.Uuid
  employee_number String    @unique @db.VarChar(255)
  permissions     Json?     @default("{}")
  deleted_at      DateTime? @db.Timestamptz(6)
  created_at      DateTime  @db.Timestamptz(6)
  updated_at      DateTime  @db.Timestamptz(6)
  users           User      @relation(fields: [user_id], references: [id], onDelete: NoAction)
}

model courses {
  id               String                 @id @db.Uuid
  code             String                 @unique @db.VarChar(20)
  name             String                 @db.VarChar(255)
  description      String?
  credits          Int
  department_id    String                 @db.Uuid
  semester         enum_courses_semester
  year             Int
  is_active        Boolean?               @default(true)
  metadata         Json?                  @default("{}")
  deleted_at       DateTime?              @db.Timestamptz(6)
  created_at       DateTime               @db.Timestamptz(6)
  updated_at       DateTime               @db.Timestamptz(6)
  attendance_limit Int                    @default(4)
  prerequisitesFor course_prerequisites[] @relation("CoursePrerequisiteCourse")
  isPrerequisiteOf course_prerequisites[] @relation("CoursePrerequisitePrereq")
  sections         course_sections[]
  departments      Department             @relation(fields: [department_id], references: [id], onDelete: NoAction)

  @@index([code], map: "courses_code")
  @@index([department_id], map: "courses_department_id")
  @@index([semester, year], map: "courses_semester_year")
}

model course_sections {
  id                 String                @id @default(uuid()) @db.Uuid
  course_id          String                @db.Uuid
  section_number     Int
  semester           enum_courses_semester
  year               Int
  instructor_id      String                @db.Uuid
  capacity           Int
  enrolled_count     Int                   @default(0)
  schedule_json      Json?
  created_at         DateTime              @default(now()) @db.Timestamptz(6)
  updated_at         DateTime              @updatedAt @db.Timestamptz(6)
  deleted_at         DateTime?             @db.Timestamptz(6)
  attendanceSessions attendance_sessions[]
  courses            courses               @relation(fields: [course_id], references: [id], onDelete: Cascade)
  enrollments        enrollments[]
  schedules          Schedule[]

  @@index([course_id], map: "sections_course_id")
  @@index([instructor_id], map: "sections_instructor_id")
}

model course_prerequisites {
  id                     String  @id @default(uuid()) @db.Uuid
  course_id              String  @db.Uuid
  prerequisite_course_id String  @db.Uuid
  courses                courses @relation("CoursePrerequisiteCourse", fields: [course_id], references: [id], onDelete: Cascade)
  prerequisite           courses @relation("CoursePrerequisitePrereq", fields: [prerequisite_course_id], references: [id], onDelete: Cascade)

  @@index([course_id], map: "prereq_course_id")
  @@index([prerequisite_course_id], map: "prereq_prerequisite_id")
}

model enrollments {
  id              String          @id @default(uuid()) @db.Uuid
  student_id      String          @db.Uuid
  section_id      String          @db.Uuid
  status          String          @default("active")
  enrollment_date DateTime        @default(now()) @db.Timestamptz(6)
  midterm_grade   Float?
  final_grade     Float?
  letter_grade    String?
  grade_point     Float?
  created_at      DateTime        @default(now()) @db.Timestamptz(6)
  updated_at      DateTime        @updatedAt @db.Timestamptz(6)
  section         course_sections @relation(fields: [section_id], references: [id], onDelete: Cascade)
  student         Student         @relation(fields: [student_id], references: [id], onDelete: Cascade)

  @@index([student_id], map: "enrollments_student_id")
  @@index([section_id], map: "enrollments_section_id")
}

model attendance_sessions {
  id                String               @id @default(uuid()) @db.Uuid
  section_id        String               @db.Uuid
  instructor_id     String?              @db.Uuid
  date              DateTime             @db.Date
  start_time        DateTime             @db.Timestamptz(6)
  end_time          DateTime             @db.Timestamptz(6)
  latitude          Float
  longitude         Float
  geofence_radius   Float                @default(15)
  qr_code           String?
  status            String               @default("active")
  created_at        DateTime             @default(now()) @db.Timestamptz(6)
  updated_at        DateTime             @updatedAt @db.Timestamptz(6)
  attendanceRecords attendance_records[]
  section           course_sections      @relation(fields: [section_id], references: [id], onDelete: Cascade)
  excuseRequests    excuse_requests[]

  @@index([section_id], map: "attendance_sessions_section_id")
  @@index([instructor_id], map: "attendance_sessions_instructor_id")
}

model attendance_records {
  id                   String              @id @default(uuid()) @db.Uuid
  session_id           String              @db.Uuid
  student_id           String              @db.Uuid
  check_in_time        DateTime            @db.Timestamptz(6)
  latitude             Float
  longitude            Float
  distance_from_center Float
  is_flagged           Boolean             @default(false)
  flag_reason          String?
  created_at           DateTime            @default(now()) @db.Timestamptz(6)
  updated_at           DateTime            @updatedAt @db.Timestamptz(6)
  session              attendance_sessions @relation(fields: [session_id], references: [id], onDelete: Cascade)
  student              Student             @relation(fields: [student_id], references: [id], onDelete: Cascade)

  @@index([session_id], map: "attendance_records_session_id")
  @@index([student_id], map: "attendance_records_student_id")
}

model excuse_requests {
  id           String              @id @default(uuid()) @db.Uuid
  student_id   String              @db.Uuid
  session_id   String              @db.Uuid
  reason       String
  document_url String?
  status       String              @default("pending")
  reviewed_by  String?
  reviewed_at  DateTime?
  notes        String?
  created_at   DateTime            @default(now()) @db.Timestamptz(6)
  updated_at   DateTime            @updatedAt @db.Timestamptz(6)
  session      attendance_sessions @relation(fields: [session_id], references: [id], onDelete: Cascade)
  student      Student             @relation(fields: [student_id], references: [id], onDelete: Cascade)

  @@index([student_id], map: "excuse_requests_student_id")
  @@index([session_id], map: "excuse_requests_session_id")
}

model classrooms {
  id            String                 @id @default(uuid()) @db.Uuid
  building      String
  room_number   String
  capacity      Int
  features_json Json?
  latitude      Float?
  longitude     Float?
  created_at    DateTime               @default(now()) @db.Timestamptz(6)
  updated_at    DateTime               @updatedAt @db.Timestamptz(6)
  schedules     Schedule[]
  reservations  ClassroomReservation[]
}

enum enum_courses_semester {
  fall
  spring
  summer
}

enum enum_users_role {
  student
  faculty
  admin
}

enum MealType {
  breakfast
  lunch
  dinner
}

enum MealReservationStatus {
  reserved
  used
  cancelled
}

enum TransactionType {
  credit
  debit
}

enum TransactionReferenceType {
  topup
  meal_reservation
  event_registration
  refund
}

enum EventCategory {
  conference
  workshop
  social
  sports
  academic
  cultural
}

enum EventStatus {
  draft
  published
  cancelled
  completed
}

enum DayOfWeek {
  monday
  tuesday
  wednesday
  thursday
  friday
  saturday
  sunday
}

enum ReservationStatus {
  pending
  approved
  rejected
  cancelled
}

// ============================================
// MEAL SERVICE MODELS
// ============================================

model Cafeteria {
  id           String            @id @default(uuid()) @db.Uuid
  name         String            @db.VarChar(255)
  location     String            @db.VarChar(255)
  capacity     Int
  created_at   DateTime          @default(now()) @db.Timestamptz(6)
  updated_at   DateTime          @updatedAt @db.Timestamptz(6)
  menus        MealMenu[]
  reservations MealReservation[]

  @@map("cafeterias")
}

model MealMenu {
  id             String            @id @default(uuid()) @db.Uuid
  cafeteria_id   String            @map("cafeteria_id") @db.Uuid
  date           DateTime          @db.Date
  meal_type      MealType          @map("meal_type")
  items_json     Json              @map("items_json")
  nutrition_json Json?             @map("nutrition_json")
  is_published   Boolean           @default(false) @map("is_published")
  created_at     DateTime          @default(now()) @db.Timestamptz(6)
  updated_at     DateTime          @updatedAt @db.Timestamptz(6)
  cafeteria      Cafeteria         @relation(fields: [cafeteria_id], references: [id], onDelete: Cascade)
  reservations   MealReservation[]

  @@index([cafeteria_id, date, meal_type], map: "meal_menus_cafeteria_date_type")
  @@map("meal_menus")
}

model MealReservation {
  id           String                @id @default(uuid()) @db.Uuid
  user_id      String                @map("user_id") @db.Uuid
  menu_id      String                @map("menu_id") @db.Uuid
  cafeteria_id String                @map("cafeteria_id") @db.Uuid
  meal_type    MealType              @map("meal_type")
  date         DateTime              @db.Date
  amount       Decimal               @db.Decimal(10, 2)
  qr_code      String                @unique @map("qr_code") @db.VarChar(255)
  status       MealReservationStatus @default(reserved)
  used_at      DateTime?             @map("used_at") @db.Timestamptz(6)
  created_at   DateTime              @default(now()) @db.Timestamptz(6)
  updated_at   DateTime              @updatedAt @db.Timestamptz(6)
  user         User                  @relation(fields: [user_id], references: [id], onDelete: Cascade)
  menu         MealMenu              @relation(fields: [menu_id], references: [id], onDelete: Cascade)
  cafeteria    Cafeteria             @relation(fields: [cafeteria_id], references: [id], onDelete: Cascade)

  @@index([user_id, date], map: "meal_reservations_user_date")
  @@index([qr_code], map: "meal_reservations_qr_code")
  @@map("meal_reservations")
}

// ============================================
// WALLET MODELS
// ============================================

model Wallet {
  id           String        @id @default(uuid()) @db.Uuid
  user_id      String        @unique @map("user_id") @db.Uuid
  balance      Decimal       @default(0) @db.Decimal(10, 2)
  currency     String        @default("TRY") @db.VarChar(10)
  is_active    Boolean       @default(true) @map("is_active")
  created_at   DateTime      @default(now()) @db.Timestamptz(6)
  updated_at   DateTime      @updatedAt @db.Timestamptz(6)
  user         User          @relation(fields: [user_id], references: [id], onDelete: Cascade)
  transactions Transaction[]

  @@map("wallets")
}

model Transaction {
  id             String                   @id @default(uuid()) @db.Uuid
  wallet_id      String                   @map("wallet_id") @db.Uuid
  type           TransactionType
  amount         Decimal                  @db.Decimal(10, 2)
  balance_after  Decimal                  @map("balance_after") @db.Decimal(10, 2)
  reference_type TransactionReferenceType @map("reference_type")
  reference_id   String?                  @map("reference_id") @db.Uuid
  description    String?                  @db.Text
  created_at     DateTime                 @default(now()) @db.Timestamptz(6)
  wallet         Wallet                   @relation(fields: [wallet_id], references: [id], onDelete: Cascade)

  @@index([wallet_id], map: "transactions_wallet_id")
  @@index([reference_type, reference_id], map: "transactions_reference")
  @@map("transactions")
}

// ============================================
// EVENT MODELS
// ============================================

model Event {
  id                    String              @id @default(uuid()) @db.Uuid
  title                 String              @db.VarChar(255)
  description           String?             @db.Text
  category              EventCategory
  date                  DateTime            @db.Date
  start_time            String              @map("start_time") @db.VarChar(10)
  end_time              String              @map("end_time") @db.VarChar(10)
  location              String              @db.VarChar(255)
  capacity              Int
  registered_count      Int                 @default(0) @map("registered_count")
  registration_deadline DateTime            @map("registration_deadline") @db.Timestamptz(6)
  is_paid               Boolean             @default(false) @map("is_paid")
  price                 Decimal?            @db.Decimal(10, 2)
  status                EventStatus         @default(draft)
  created_at            DateTime            @default(now()) @db.Timestamptz(6)
  updated_at            DateTime            @updatedAt @db.Timestamptz(6)
  registrations         EventRegistration[]

  @@index([category, date], map: "events_category_date")
  @@index([status], map: "events_status")
  @@map("events")
}

model EventRegistration {
  id                 String    @id @default(uuid()) @db.Uuid
  event_id           String    @map("event_id") @db.Uuid
  user_id            String    @map("user_id") @db.Uuid
  registration_date  DateTime  @default(now()) @map("registration_date") @db.Timestamptz(6)
  qr_code            String    @unique @map("qr_code") @db.VarChar(255)
  checked_in         Boolean   @default(false) @map("checked_in")
  checked_in_at      DateTime? @map("checked_in_at") @db.Timestamptz(6)
  custom_fields_json Json?     @map("custom_fields_json")
  created_at         DateTime  @default(now()) @db.Timestamptz(6)
  updated_at         DateTime  @updatedAt @db.Timestamptz(6)
  event              Event     @relation(fields: [event_id], references: [id], onDelete: Cascade)
  user               User      @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([event_id], map: "event_registrations_event_id")
  @@index([user_id], map: "event_registrations_user_id")
  @@index([qr_code], map: "event_registrations_qr_code")
  @@map("event_registrations")
}

// ============================================
// SCHEDULING MODELS
// ============================================

model Schedule {
  id           String          @id @default(uuid()) @db.Uuid
  section_id   String          @map("section_id") @db.Uuid
  day_of_week  DayOfWeek       @map("day_of_week")
  start_time   String          @map("start_time") @db.VarChar(10)
  end_time     String          @map("end_time") @db.VarChar(10)
  classroom_id String          @map("classroom_id") @db.Uuid
  created_at   DateTime        @default(now()) @db.Timestamptz(6)
  updated_at   DateTime        @updatedAt @db.Timestamptz(6)
  section      course_sections @relation(fields: [section_id], references: [id], onDelete: Cascade)
  classroom    classrooms      @relation(fields: [classroom_id], references: [id], onDelete: Cascade)

  @@index([section_id], map: "schedules_section_id")
  @@index([classroom_id, day_of_week], map: "schedules_classroom_day")
  @@map("schedules")
}

// ============================================
// CLASSROOM RESERVATION MODELS
// ============================================

model ClassroomReservation {
  id           String            @id @default(uuid()) @db.Uuid
  classroom_id String            @map("classroom_id") @db.Uuid
  user_id      String            @map("user_id") @db.Uuid
  date         DateTime          @db.Date
  start_time   String            @map("start_time") @db.VarChar(10)
  end_time     String            @map("end_time") @db.VarChar(10)
  purpose      String            @db.VarChar(255)
  status       ReservationStatus @default(pending)
  approved_by  String?           @map("approved_by") @db.Uuid
  created_at   DateTime          @default(now()) @db.Timestamptz(6)
  updated_at   DateTime          @updatedAt @db.Timestamptz(6)
  classroom    classrooms        @relation(fields: [classroom_id], references: [id], onDelete: Cascade)
  user         User              @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([classroom_id, date], map: "reservations_classroom_date")
  @@index([user_id], map: "reservations_user_id")
  @@index([status], map: "reservations_status")
  @@map("reservations")
}
